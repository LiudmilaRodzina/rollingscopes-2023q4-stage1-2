var R=Object.defineProperty;var _=(r,e,t)=>e in r?R(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var N=(r,e,t)=>(_(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();class f{constructor(e={tag:"",classNames:[],textContent:""}){N(this,"element");this.element=null,this.createElement(e)}createElement(e){this.element=document.createElement(e.tag),this.setCssClasses(e.classNames),this.setTextContent(e.textContent)}setCssClasses(e){e.forEach(t=>{this.element&&this.element.classList.add(t)})}setTextContent(e){this.element&&(this.element.textContent=e)}getElement(){return this.element}}const b="About",C="Logout",M="The Rolling Scopes School educational project (JavaScript/Front-end 2023Q4)",B="by Liudmila Rodzina",A="off",D="button",P="input",x=2,G=3,d={USER_GREETING:"user-greeting",LOGIN_CONTAINER:"login-container",CONTENT_CONTAINER:"content-container",CHAT_CONTAINER:"chat-container",INFO_CONTAINER:"info-container",BUTTON_LOGIN:"button-login",BUTTON_LOGOUT:"button-logout",BUTTON_INFO:"button-info",INPUT_FIELD:"input-field",INPUT_LABEL:"input-label",ERROR_MESSAGE_CLASS:"error-message"},c={DIV:"div",FORM:"form",BTN:"button",INPUT:"input",LABEL:"label",P:"p",SPAN:"span"},p={LOGIN:"Login:",PASSWORD:"Password:",LOGIN_BTN:"Login",BLANK:""},T={NAME:"name"},L={LOGIN:"login",PASSWORD:"password",BLANK:""},O={INFO:"info",CHAT:"chat"};class F extends f{constructor(){super({tag:c.FORM,classNames:[d.LOGIN_CONTAINER],textContent:""}),this.createLoginView()}addElement(e,t,s,n,o=""){const a={tag:e,textContent:t,classNames:n},i=new f(a),u=this.getElement();if(u&&(u.append(i.getElement()),e===c.INPUT)){const E=i.getElement();E.name=s,o&&E.setAttribute("autocomplete",o)}}createLoginView(){var s;this.addElement(c.LABEL,p.LOGIN_BTN,L.BLANK,[d.INPUT_LABEL]),this.addElement(c.INPUT,p.BLANK,L.LOGIN,[d.INPUT_FIELD,"login"],A),this.addElement(c.LABEL,p.PASSWORD,L.BLANK,[d.INPUT_LABEL]),this.addElement(c.INPUT,p.BLANK,L.PASSWORD,[d.INPUT_FIELD,"password"],A);const t=new f({tag:c.BTN,textContent:p.LOGIN_BTN,classNames:[d.BUTTON_LOGIN]}).getElement();t.disabled=!0,(s=this.getElement())==null||s.append(t)}}var S=(r=>(r.CharacterRestriction="Please enter only Latin letters or digits (0-9)",r.LengthRestrictionLogin="Login must be at least 2 characters long",r.LengthRestrictionPassword="Password must be at least 3 characters long",r))(S||{});const h=class h{static saveUserData(e){h.validateUserData(e)&&sessionStorage.setItem(h.USER_DATA_KEY,JSON.stringify(e))}static validateUserData(e){return e&&Object.values(e).every(t=>t.trim()!=="")}static removeUserData(){sessionStorage.removeItem(h.USER_DATA_KEY)}static getUserData(){const e=sessionStorage.getItem(h.USER_DATA_KEY)||"{}";return JSON.parse(e)}};N(h,"USER_DATA_KEY","currentUser");let l=h;class w extends f{constructor(){super({tag:c.DIV,classNames:[d.INFO_CONTAINER],textContent:""}),this.addContent(),this.addLogoutButton()}addContent(){var s;const e=document.createElement(c.P);e.textContent=M;const t=document.createElement(c.SPAN);t.textContent=B,(s=this.getElement())==null||s.append(e,t)}addLogoutButton(){var t;const e=document.createElement(c.BTN);e.textContent=C,e.classList.add(d.BUTTON_LOGOUT),e.addEventListener("click",()=>{l.removeUserData();const n=window.location.pathname.split("/").slice(0,-1).join("/");window.location.href=`${window.location.origin}${n}/`}),(t=this.getElement())==null||t.append(e)}}const g=new WebSocket("ws://127.0.0.1:4000");class y{constructor(){const e=document.querySelector(".button-login"),t=document.querySelector(".login"),s=document.querySelector(".password"),n=document.querySelector(".dot"),o=l.getUserData();o&&this.updateUser(o.login);const a=i=>{n&&(i?(n.classList.remove("dot--red"),n.classList.add("dot--green")):(n.classList.remove("dot--green"),n.classList.add("dot--red")))};g.readyState===WebSocket.OPEN&&a(!0),g.addEventListener("open",()=>{a(!0),e.addEventListener("click",i=>{i.preventDefault();const u=this.generateRequestId(),E=JSON.stringify({id:u,type:"USER_LOGIN",payload:{user:{login:t.value,password:s.value}}});g.send(E);const v=l.getUserData();this.updateUser(v.login),a(!0)})})}updateUser(e){const t=document.querySelector(".user-current");t.innerText=e}generateRequestId(){return Math.random().toString(36).substr(2,9)}}class U{constructor(){const e=document.querySelector(".chat-input"),t=document.querySelector(".button-send");t&&t.addEventListener("click",()=>{this.sendMessage(e.value.trim())});const s=l.getUserData();s&&this.updateUser(s.login),g.onopen=()=>{this.updateOnlineDot(!0),g.onmessage=({data:n})=>{const o=l.getUserData(),{type:a,payload:i}=JSON.parse(n);a==="ERROR"&&(this.updateUser(o.login),this.updateOnlineDot(!0)),a==="NEW_MESSAGE"&&this.showMessage(i.message,i.userId,!1)}},e.addEventListener("keydown",n=>{if(n.key==="Enter"){n.preventDefault();const o=e.value.trim();if(o&&g.readyState===WebSocket.OPEN){const a=this.generateRequestId(),i=JSON.stringify({id:a,type:"MSG_SEND",payload:{message:{to:"recipientLogin",text:o}}});g.send(i);const u=l.getUserData();this.showMessage(o,u.login,!0),e.value=""}}})}sendMessage(e){const t=l.getUserData();if(e&&g.readyState===WebSocket.OPEN){const s=this.generateRequestId(),n=JSON.stringify({id:s,type:"MSG_SEND",payload:{message:{to:"recipientLogin",text:e}}});g.send(n),this.showMessage(e,t.login,!0);const o=document.querySelector(".chat-input");o.value=""}}updateUser(e){const t=document.querySelector(".user-current"),s=l.getUserData();t.innerText=s.login}generateRequestId(){return Math.random().toString(36).substr(2,9)}showMessage(e,t,s){const n=l.getUserData(),o=document.querySelector(".chat-field"),a=document.createElement("div");a.className=`message message--${s?"right":"left"}`;const i=document.createElement("span");i.className="message-user",i.innerText=n.login;const u=document.createElement("span");u.innerText=e,a.append(i,u),o==null||o.append(a),o==null||o.scrollTo(0,o.scrollHeight)}updateOnlineDot(e){const t=document.querySelector(".dot");t&&(e?(t.classList.remove("dot--red"),t.classList.add("dot--green")):(t.classList.remove("dot--green"),t.classList.add("dot--red")))}}class I extends f{constructor(){super({tag:c.DIV,classNames:[d.CHAT_CONTAINER],textContent:""}),this.addButtonsContainer(),this.addContent()}addContent(){var E;const e=document.createElement("div");e.classList.add("chat");const t=document.createElement("div");t.classList.add("header");const s=document.createElement("div");s.classList.add("dot","dot--red");const n=document.createElement("div");n.classList.add("user-current"),t.append(s,n);const o=document.createElement("div");o.classList.add("chat-field");const a=document.createElement("div");a.classList.add("form");const i=document.createElement("textarea");i.classList.add("chat-input");const u=document.createElement("button");u.classList.add("button-send"),u.textContent="=>",a.append(i,u),e.append(t,o,a),document.body.innerHTML="",document.body.appendChild(this.getElement()),(E=document.querySelector(".chat-container"))==null||E.appendChild(e),new U,new y}addButtonsContainer(){var t;const e=document.createElement("div");e.classList.add("buttons-container"),this.addInfoButton(e),this.addFunChatText(e),this.addLogoutButton(e),(t=this.getElement())==null||t.appendChild(e)}addFunChatText(e){const t=document.createTextNode("Fun Chat");e.appendChild(t)}addInfoButton(e){const t=document.createElement(c.BTN);t.textContent=b,t.classList.add(d.BUTTON_INFO),t.addEventListener("click",()=>{window.location.hash=O.INFO;const s=new w;document.body.innerHTML="",document.body.append(s.getElement())}),e.appendChild(t)}addLogoutButton(e){const t=document.createElement(c.BTN);t.textContent=C,t.classList.add(d.BUTTON_LOGOUT),t.addEventListener("click",()=>{l.removeUserData();const n=window.location.pathname.split("/").slice(0,-1).join("/");window.location.href=`${window.location.origin}${n}/`}),e.appendChild(t)}}class m{constructor(e,t,s){N(this,"formElement");N(this,"loginButton");N(this,"allInputs");this.formElement=e,this.loginButton=this.formElement.querySelector(t),this.allInputs=Array.from(this.formElement.querySelectorAll(s))}setupValidation(){this.loginButton&&(this.loginButton.addEventListener("click",()=>{const e=this.getUserDataFromInputs();e&&l.saveUserData(e),m.displayChatView()}),this.allInputs.forEach(e=>{e.addEventListener("input",()=>{this.validateEmptyInputs(),this.validateCharacterRestriction(e),m.validateMinimumLength(e)}),e.tagName===c.INPUT&&e.setAttribute("required","true")}))}validateEmptyInputs(){const e=this.allInputs.every(t=>t.value.trim()!==""&&this.validateCharacterRestriction(t)&&m.validateMinimumLength(t));this.loginButton&&(this.loginButton.disabled=!e)}validateCharacterRestriction(e){if(!/^[a-zA-Z0-9]*$/.test(e.value)){const s=S.CharacterRestriction;return this.hideAllErrorMessages(e),m.showErrorMessage(e,s),!1}return m.hideErrorMessage(e),!0}static validateMinimumLength(e){const t=e.getAttribute(T.NAME),s=t===L.LOGIN?x:G,n=e.nextElementSibling;if(n&&n.className===d.ERROR_MESSAGE_CLASS)return!0;if(e.value.length<s){const o=t===L.LOGIN?S.LengthRestrictionLogin:S.LengthRestrictionPassword;return m.showErrorMessage(e,o),!1}return m.hideErrorMessage(e),!0}static showErrorMessage(e,t){const s=e.nextElementSibling;if(!s||s.className!==d.ERROR_MESSAGE_CLASS){const n=document.createElement(c.SPAN);n.className=d.ERROR_MESSAGE_CLASS,n.textContent=t,e.insertAdjacentElement("afterend",n)}}static hideErrorMessage(e){const t=e.nextElementSibling;t&&t.className===d.ERROR_MESSAGE_CLASS&&t.remove()}hideAllErrorMessages(e){this.allInputs.forEach(t=>{m.skipErrorHiding(e,t)||m.hideErrorMessage(t)})}static skipErrorHiding(e,t){return t===e?!1:e.getAttribute(T.NAME)!==t.getAttribute(T.NAME)}getUserDataFromInputs(){const e={};return this.allInputs.forEach(t=>{const s=t.getAttribute(T.NAME),n=t.value.trim();s&&n&&(e[s]=n)}),Object.keys(e).length>0?e:null}static displayChatView(){const e=l.getUserData();if(e){const s=new I().getElement();if(s){const n=document.querySelector(".messenger__user");n&&(n.innerText=e.login),window.history.pushState(null,"",`#${O.CHAT}`),document.body.innerHTML="",document.body.append(s)}}}static stayLoggedInOnLoad(){document.addEventListener("DOMContentLoaded",()=>{const{hash:e}=window.location;if(e===`#${O.CHAT}`){const s=new I().getElement();s&&(document.body.innerHTML="",document.body.append(s))}if(e===`#${O.INFO}`){const s=new w().getElement();s&&(document.body.innerHTML="",document.body.append(s))}})}}class q{constructor(){document.addEventListener("DOMContentLoaded",()=>{new U,new y})}}class V{static createView(){const e=new F,t=document.body;if(t){t.append(e.getElement());const s=e.getElement();new m(s,D,P).setupValidation()}m.stayLoggedInOnLoad(),new q}}class K{constructor(){V.createView()}}new K;
